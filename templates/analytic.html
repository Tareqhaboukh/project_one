{% extends "base.html" %}

{% block content %}
<div class="flex-1">
    <h2 class="text-2xl font-bold mb-4 text-center">Analytics</h2>

    <!-- Custom multi-select dropdown -->
    <div class="mb-4 relative" id="vendorDropdownContainer">
        <label class="block mb-1 font-semibold">Select Vendors:</label>
        <button id="vendorDropdownButton" type="button"
                class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-left flex justify-between items-center">
            <span id="vendorDropdownLabel">Select vendors</span>
            <svg class="w-5 h-5 transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        <div id="vendorDropdownMenu"
                class="hidden absolute mt-1 w-full bg-white border border-gray-300 rounded shadow max-h-60 flex flex-col z-10">
            <!-- Scrollable vendor list -->
            <div id="vendorOptions" class="overflow-auto flex-1">
                {% for vendor in vendors %}
                <label class="flex items-center px-3 py-1 hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" value="{{ vendor.id }}" class="vendorCheckbox mr-2"
                        {% if selected_vendor and (vendor.id|string) in selected_vendor %}checked{% endif %}>
                    {{ vendor.vendor_name }}
                </label>
                {% endfor %}
            </div>
            <!-- Fixed bottom buttons -->
            <div class="p-2 border-t border-gray-200 flex justify-between items-center">
                <button type="button" class="bg-blue-600 text-white py-1 px-8 rounded hover:bg-blue-700 font-medium" id="applyVendorsBtn">Apply</button>
                <div class="flex gap-4">
                    <span id="selectAllBtn" class="text-blue-600 cursor-pointer hover:underline text-sm font-medium px-2">Select All</span>
                    <span id="selectNoneBtn" class="text-blue-600 cursor-pointer hover:underline text-sm font-medium px-2">Select None</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Centered Bar graph container -->
    <div class="flex justify-center">
        <div id="barGraph" class="w-full mx-auto"></div>
    </div>
</div>

<div class="mt-auto">
    <a href="{{ url_for('dashboard') }}"
        class="flex items-center justify-center gap-2 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded shadow-sm transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Dashboard
    </a>
</div>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
const barData = {{ bar_data | tojson }};
const barGraphDiv = document.getElementById('barGraph');

function renderPlot(data) {
    if (!data || data.length === 0) {
        barGraphDiv.innerHTML = '';
        return;
    }

    const traceAmount = {
        x: data.map(d => d.vendor),
        y: data.map(d => d.amount),
        name: 'Amount',
        type: 'bar',
        marker: { color: '#3b82f6' },
        width: 0.4
    };

    const traceTax = {
        x: data.map(d => d.vendor),
        y: data.map(d => d.tax),
        name: 'Tax',
        type: 'bar',
        marker: { color: '#f59e0b' },
        width: 0.4
    };

Plotly.newPlot(barGraphDiv, [traceAmount, traceTax], {
    barmode: 'stack',
    margin: { t: 40, b: 60, l: 60, r: 60 },
    legend: { x: 0.5, y: -0.2, xanchor: 'center', yanchor: 'top', orientation: 'h' },
    xaxis: { type: 'category', automargin: true, fixedrange: false },
    yaxis: { showticklabels: true, tickprefix: '$', separatethousands: true, automargin: true },
    hovermode: false,
    height: 700
}, { displayModeBar: false, responsive: true });
}

// Initial render
renderPlot(barData);

// Dropdown toggle
const dropdownButton = document.getElementById('vendorDropdownButton');
const dropdownMenu = document.getElementById('vendorDropdownMenu');
const dropdownLabel = document.getElementById('vendorDropdownLabel');
dropdownButton.addEventListener('click', () => {
    dropdownMenu.classList.toggle('hidden');
});

// Update dropdown label
function updateDropdownLabel() {
    const selected = Array.from(document.querySelectorAll('.vendorCheckbox:checked'))
                          .map(cb => cb.nextSibling.textContent.trim());
    dropdownLabel.textContent = selected.length ? selected.length + ' vendor(s) selected' : 'Select vendors';
}
updateDropdownLabel();
document.querySelectorAll('.vendorCheckbox').forEach(cb => cb.addEventListener('change', updateDropdownLabel));

// Select All / None buttons
document.getElementById('selectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.vendorCheckbox').forEach(cb => cb.checked = true);
    updateDropdownLabel();
});
document.getElementById('selectNoneBtn').addEventListener('click', () => {
    document.querySelectorAll('.vendorCheckbox').forEach(cb => cb.checked = false);
    updateDropdownLabel();
});

// Apply button
document.getElementById('applyVendorsBtn').addEventListener('click', () => {
    const selectedIds = Array.from(document.querySelectorAll('.vendorCheckbox:checked'))
                             .map(cb => cb.value);
    if (selectedIds.length > 0) {
        const query = selectedIds.map(id => 'vendor_id=' + id).join('&');
        window.location.href = '/analytic?' + query;
    } else {
        window.location.href = '/analytic';
    }
});

// Close dropdown if clicked outside
document.addEventListener('click', function(event) {
    if (!document.getElementById('vendorDropdownContainer').contains(event.target)) {
        dropdownMenu.classList.add('hidden');
    }
});
</script>
{% endblock %}