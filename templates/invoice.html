{% extends "base.html" %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-center">Invoices List</h2>

<div class="mb-4">
    <input type="text" id="invoiceSearch" placeholder="Search invoices..."
            class="w-full border p-2 rounded" />
</div>

{% if invoices %}
<!-- Scrollable table wrapper -->
<div class="flex-1 overflow-auto max-h-[650px]">
    <table id="invoicesTable" class="min-w-full table-auto border-collapse text-xs">
        <thead class="bg-gray-100 sticky top-0 border-b border-gray-300">
            <tr>
                <th class="border px-4 py-2">Invoice Number</th>
                <th class="border px-4 py-2">Vendor</th>
                <th class="border px-4 py-2">Amount</th>
                <th class="border px-4 py-2">Tax</th>
            </tr>
        </thead>
        <tbody>
            {% set total_amount = 0 %}
            {% set total_tax = 0 %}
            {% for invoice in invoices %}
            <tr data-id="{{ invoice.id }}" class="cursor-pointer hover:bg-gray-50 leading-tight">
                <td class="border px-4 py-2">{{ invoice.invoice_number }}</td>
                <td class="border px-4 py-2">{{ invoice.vendor.vendor_name }}</td>
                <td class="border px-4 py-2">${{ '%.2f'|format(invoice.amount) }}</td>
                <td class="border px-4 py-2">${{ '%.2f'|format(invoice.tax) }}</td>
            </tr>
            {% set total_amount = total_amount + invoice.amount %}
            {% set total_tax = total_tax + invoice.tax %}
            {% endfor %}
        </tbody>
        <tfoot class="bg-gray-100 font-bold sticky bottom-0">
            <tr>
                <td class="border px-0 py-1 text-right" colspan="2">Total</td>
                <td id="totalAmount" class="border px-4 py-2">${{ '%.2f'|format(total_amount) }}</td>
                <td id="totalTax" class="border px-4 py-2">${{ '%.2f'|format(total_tax) }}</td>
            </tr>
        </tfoot>
    </table>
</div>
{% else %}
<p class="text-center text-gray-500">No invoices found.</p>
{% endif %}

<!-- Buttons stick at bottom -->
<div class="mt-auto space-y-2">
    <a href="{{ url_for('invoice_add') }}"
        class="flex items-center justify-center gap-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow-sm transition cursor-pointer">
        Submit a New Invoice
    </a>

    <a href="{{ url_for('dashboard') }}"
        class="flex items-center justify-center gap-2 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded shadow-sm transition cursor-pointer">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Dashboard
    </a>
</div>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- Cloudflare Web Analytics -->
<script defer src="https://static.cloudflareinsights.com/beacon.min.js"
        data-cf-beacon='{"token": "54b0b08ba67148b891d5416396746948"}'></script>
<!-- End Cloudflare Web Analytics -->

<script>
$(document).ready(function() {
    var table = $('#invoicesTable').DataTable({
        "paging": false,
        "info": false,
        "autoWidth": true,
        "dom": 't'
    });

    $('#invoicesTable tbody').on('click', 'tr', function() {
        var invoiceId = $(this).data('id');
        if (invoiceId) {
            window.location.href = '/invoice/view/' + invoiceId;
        }
    });

    function updateTotals() {
        let totalAmount = 0;
        let totalTax = 0;
        table.rows({ search: 'applied' }).every(function() {
            var data = this.data();
            totalAmount += parseFloat(data[2].replace(/[$,]/g, '')) || 0;
            totalTax += parseFloat(data[3].replace(/[$,]/g, '')) || 0;
        });
        $('#totalAmount').text('$' + totalAmount.toFixed(2));
        $('#totalTax').text('$' + totalTax.toFixed(2));
    }

    updateTotals();

    table.on('search.dt', function() {
        updateTotals();
    });

    $('#invoiceSearch').on('keyup', function() {
        table.search(this.value).draw();
    });
});
</script>
{% endblock %}